{% extends "base.html" %}

{% block title %}çŸ¥è¯†å›¾è°± - AI Note System{% endblock %}

{% block content %}<div class="page-header">
    <h1>ğŸ”— çŸ¥è¯†å›¾è°±</h1>
    <p>å¯è§†åŒ–ç¬”è®°é—´çš„å®ä½“å…³ç³»å’Œè¯­ä¹‰è¿æ¥</p>
</div>

<div class="graph-stats" id="graph-stats">
    <span class="stat"><strong id="entity-count">-</strong> å®ä½“</span>
    <span class="stat"><strong id="relation-count">-</strong> å…³ç³»</span>
    <span class="stat"><strong id="note-count">-</strong> ç¬”è®°</span>
</div>

<div class="graph-container">
    <div class="graph-sidebar">
        <div class="search-box">
            <input type="text" id="entity-search" placeholder="æœç´¢å®ä½“...">
            <button id="search-btn">ğŸ”</button>
        </div>
        
        <div class="entity-list" id="entity-list">
            <p class="placeholder">åŠ è½½å®ä½“åˆ—è¡¨...</p>
        </div>
    </div>
    
    <div class="graph-view" id="graph-view">
        <div class="graph-placeholder">
            <p>ğŸ•¸ï¸ çŸ¥è¯†å›¾è°±å¯è§†åŒ–</p>
            <p class="hint">ç‚¹å‡»å·¦ä¾§å®ä½“æŸ¥çœ‹å…³è”ç½‘ç»œ</p>
        </div>
    </div>
</div>

<div class="entity-detail" id="entity-detail" style="display: none;">
    <h3 id="detail-name"></h3>
    <p id="detail-type"></p>
    <p id="detail-description"></p>
</div>
{% endblock %}

{% block scripts %}<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
let currentGraph = { nodes: [], links: [] };

// åŠ è½½å›¾è°±ç»Ÿè®¡
async function loadStats() {
    try {
        const res = await fetch('/api/stats');
        const data = await res.json();
        
        if (data.graph_stats) {
            document.getElementById('entity-count').textContent = data.graph_stats.entities || 0;
            document.getElementById('relation-count').textContent = data.graph_stats.relations || 0;
            document.getElementById('note-count').textContent = data.graph_stats.notes || 0;
        }
    } catch (e) {
        console.error('Failed to load stats:', e);
    }
}

// åŠ è½½å®ä½“åˆ—è¡¨
async function loadEntities() {
    try {
        const res = await fetch('/api/graph/entities');
        const data = await res.json();
        
        const listEl = document.getElementById('entity-list');
        
        if (!data.entities || data.entities.length === 0) {
            listEl.innerHTML = '<p class="placeholder">æš‚æ— å®ä½“æ•°æ®<br>è¯·å…ˆä¸Šä¼ ä¸€äº›ç¬”è®°</p>';
            return;
        }
        
        listEl.innerHTML = data.entities.map(e => `
            <div class="entity-item" data-name="${e.name}" data-type="${e.type}">
                <span class="entity-type-badge type-${e.type}">${getTypeIcon(e.type)}</span>
                <span class="entity-name">${e.name}</span>
            </div>
        `).join('');
        
        // ç»‘å®šç‚¹å‡»äº‹ä»¶
        document.querySelectorAll('.entity-item').forEach(item => {
            item.addEventListener('click', () => {
                const name = item.dataset.name;
                loadEntityNetwork(name);
            });
        });
        
    } catch (e) {
        document.getElementById('entity-list').innerHTML = `<p class="placeholder">åŠ è½½å¤±è´¥: ${e.message}</p>`;
    }
}

// è·å–ç±»å‹å›¾æ ‡
function getTypeIcon(type) {
    const icons = {
        'person': 'ğŸ‘¤',
        'organization': 'ğŸ¢',
        'concept': 'ğŸ’¡',
        'technology': 'âš™ï¸',
        'product': 'ğŸ“¦',
        'location': 'ğŸ“',
        'event': 'ğŸ“…',
        'field': 'ğŸ”¬'
    };
    return icons[type] || 'ğŸ·ï¸';
}

// åŠ è½½å®ä½“ç½‘ç»œ
async function loadEntityNetwork(entityName) {
    try {
        const res = await fetch(`/api/graph/network?name=${encodeURIComponent(entityName)}`);
        const data = await res.json();
        
        if (data.nodes.length === 0) {
            document.getElementById('graph-view').innerHTML = `
                <div class="graph-placeholder">
                    <p>æœªæ‰¾åˆ° "${entityName}" çš„å…³è”ç½‘ç»œ</p>
                </div>
            `;
            return;
        }
        
        renderGraph(data);
        showEntityDetail(entityName);
        
    } catch (e) {
        console.error('Failed to load network:', e);
    }
}

// æ¸²æŸ“ D3 å›¾è°±
function renderGraph(data) {
    const container = document.getElementById('graph-view');
    container.innerHTML = '';
    
    const width = container.clientWidth;
    const height = container.clientHeight || 500;
    
    // åˆ›å»º SVG
    const svg = d3.select('#graph-view')
        .append('svg')
        .attr('width', width)
        .attr('height', height);
    
    // æ·»åŠ ç¼©æ”¾åŠŸèƒ½
    const g = svg.append('g');
    
    svg.call(d3.zoom()
        .extent([[0, 0], [width, height]])
        .scaleExtent([0.5, 4])
        .on('zoom', (event) => {
            g.attr('transform', event.transform);
        }));
    
    // é¢œè‰²æ˜ å°„
    const colorScale = d3.scaleOrdinal()
        .domain(['person', 'organization', 'concept', 'technology', 'product', 'location', 'event', 'field'])
        .range(['#60a5fa', '#f472b6', '#a78bfa', '#34d399', '#fbbf24', '#f87171', '#22d3ee', '#a3e635']);
    
    // åˆ›å»ºåŠ›å¯¼å‘æ¨¡æ‹Ÿ
    const simulation = d3.forceSimulation(data.nodes)
        .force('link', d3.forceLink(data.links).id(d => d.id).distance(100))
        .force('charge', d3.forceManyBody().strength(-300))
        .force('center', d3.forceCenter(width / 2, height / 2));
    
    // ç»˜åˆ¶è¿çº¿
    const link = g.append('g')
        .selectAll('line')
        .data(data.links)
        .enter()
        .append('line')
        .attr('stroke', '#94a3b8')
        .attr('stroke-width', 1.5);
    
    // ç»˜åˆ¶èŠ‚ç‚¹
    const node = g.append('g')
        .selectAll('g')
        .data(data.nodes)
        .enter()
        .append('g')
        .call(d3.drag()
            .on('start', dragstarted)
            .on('drag', dragged)
            .on('end', dragended));
    
    // èŠ‚ç‚¹åœ†åœˆ
    node.append('circle')
        .attr('r', d => d.id === data.nodes[0]?.id ? 25 : 15)
        .attr('fill', d => colorScale(d.type) || '#94a3b8')
        .attr('stroke', '#fff')
        .attr('stroke-width', 2);
    
    // èŠ‚ç‚¹æ–‡å­—
    node.append('text')
        .text(d => d.name)
        .attr('x', 20)
        .attr('y', 5)
        .attr('font-size', '12px')
        .attr('fill', '#1e293b');
    
    // èŠ‚ç‚¹ç‚¹å‡»äº‹ä»¶
    node.on('click', (event, d) => {
        loadEntityNetwork(d.name);
    });
    
    // æ›´æ–°ä½ç½®
    simulation.on('tick', () => {
        link
            .attr('x1', d => d.source.x)
            .attr('y1', d => d.source.y)
            .attr('x2', d => d.target.x)
            .attr('y2', d => d.target.y);
        
        node
            .attr('transform', d => `translate(${d.x},${d.y})`);
    });
    
    function dragstarted(event, d) {
        if (!event.active) simulation.alphaTarget(0.3).restart();
        d.fx = d.x;
        d.fy = d.y;
    }
    
    function dragged(event, d) {
        d.fx = event.x;
        d.fy = event.y;
    }
    
    function dragended(event, d) {
        if (!event.active) simulation.alphaTarget(0);
        d.fx = null;
        d.fy = null;
    }
}

// æ˜¾ç¤ºå®ä½“è¯¦æƒ…
function showEntityDetail(name) {
    const detailEl = document.getElementById('entity-detail');
    document.getElementById('detail-name').textContent = name;
    detailEl.style.display = 'block';
}

// æœç´¢å®ä½“
document.getElementById('search-btn').addEventListener('click', () => {
    const query = document.getElementById('entity-search').value.trim();
    if (query) {
        loadEntityNetwork(query);
    }
});

document.getElementById('entity-search').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        const query = e.target.value.trim();
        if (query) {
            loadEntityNetwork(query);
        }
    }
});

// åˆå§‹åŒ–
loadStats();
loadEntities();
</script>
{% endblock %}
