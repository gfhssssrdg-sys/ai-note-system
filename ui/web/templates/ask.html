{% extends "base.html" %}

{% block title %}çŸ¥è¯†é—®ç­” - AI Note System{% endblock %}

{% block content %}<div class="page-header">
    <h1>ğŸ” çŸ¥è¯†é—®ç­”</h1>
    <p class="principle">ğŸ“Œ æ ¸å¿ƒåŸåˆ™ï¼š<strong>æ— è¯æ®ï¼Œä¸å›ç­”</strong> - æ‰€æœ‰å›ç­”å¿…é¡»åŸºäºçŸ¥è¯†åº“ä¸­çš„å†…å®¹</p>
</div>

<div class="ask-container">
    <div class="question-section">
        <form id="ask-form" class="ask-form">
            <div class="form-group">
                <textarea 
                    name="question" 
                    id="question-input"
                    placeholder="è¾“å…¥ä½ çš„é—®é¢˜ï¼ŒAI å°†åŸºäºçŸ¥è¯†åº“å›ç­”..."
                    rows="3"
                    required
                ></textarea>
            </div>
            <button type="submit" class="btn btn-primary btn-large">
                ğŸ¤” æé—®
            </button>
        </form>
    </div>
    
    <div id="answer-section" class="answer-section" style="display: none;">
        <div class="answer-box">
            <h3>ğŸ“ å›ç­”</h3>
            <div id="answer-content" class="answer-content"></div>
            
            <div id="answer-meta" class="answer-meta"></div>
        </div>
        
        <div id="sources-section" class="sources-section" style="display: none;">
            <h3>ğŸ“š å‚è€ƒæ¥æº</h3>
            <ul id="sources-list" class="sources-list"></ul>
        </div>
    </div>
</div>

<div class="examples-section">
    <h3>ğŸ’¡ ç¤ºä¾‹é—®é¢˜</h3>
    <div class="example-questions">
        <button class="example-btn" data-question="ç¬”è®°ç³»ç»Ÿä¸­æ”¯æŒå“ªäº›æ–‡ä»¶æ ¼å¼ï¼Ÿ">ç¬”è®°ç³»ç»Ÿä¸­æ”¯æŒå“ªäº›æ–‡ä»¶æ ¼å¼ï¼Ÿ</button>
        <button class="example-btn" data-question="å¦‚ä½•å¤„ç†ä¸Šä¼ çš„å›¾ç‰‡ï¼Ÿ">å¦‚ä½•å¤„ç†ä¸Šä¼ çš„å›¾ç‰‡ï¼Ÿ</button>
        <button class="example-btn" data-question="çŸ¥è¯†é—®ç­”çš„æ ¸å¿ƒåŸåˆ™æ˜¯ä»€ä¹ˆï¼Ÿ">çŸ¥è¯†é—®ç­”çš„æ ¸å¿ƒåŸåˆ™æ˜¯ä»€ä¹ˆï¼Ÿ</button>
    </div>
</div>
{% endblock %}

{% block scripts %}<script>
// æé—®
document.getElementById('ask-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const question = formData.get('question');
    const answerSection = document.getElementById('answer-section');
    const answerContent = document.getElementById('answer-content');
    const answerMeta = document.getElementById('answer-meta');
    const sourcesSection = document.getElementById('sources-section');
    const sourcesList = document.getElementById('sources-list');
    
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    answerSection.style.display = 'block';
    answerContent.innerHTML = '<div class="loading">æ­£åœ¨æ€è€ƒ...</div>';
    sourcesSection.style.display = 'none';
    
    try {
        const res = await fetch('/api/ask', {
            method: 'POST',
            body: formData
        });
        const data = await res.json();
        
        if (data.success) {
            answerContent.innerHTML = formatAnswer(data.answer);
            
            // ç½®ä¿¡åº¦æ˜¾ç¤º
            const confidence = data.confidence || 0;
            const confidenceClass = confidence > 0.8 ? 'high' : confidence > 0.5 ? 'medium' : 'low';
            
            answerMeta.innerHTML = `
                <div class="confidence confidence-${confidenceClass}">
                    ç½®ä¿¡åº¦: ${(confidence * 100).toFixed(1)}%
                </div>
            `;
            
            // æ¥æºåˆ—è¡¨
            if (data.sources && data.sources.length > 0) {
                sourcesSection.style.display = 'block';
                sourcesList.innerHTML = data.sources.map(id => `
                    <li><a href="/note/${id}" target="_blank">æŸ¥çœ‹æ¥æºç¬”è®°</a></li>
                `).join('');
            }
            
            // å¦‚æœæ²¡æœ‰è¶³å¤Ÿæ¥æº
            if (!data.has_sufficient_sources) {
                answerContent.classList.add('insufficient-sources');
            } else {
                answerContent.classList.remove('insufficient-sources');
            }
        } else {
            answerContent.innerHTML = `<div class="error-box">âŒ ${data.error}</div>`;
        }
    } catch (err) {
        answerContent.innerHTML = `<div class="error-box">âŒ è¯·æ±‚å¤±è´¥: ${err.message}</div>`;
    }
});

// æ ¼å¼åŒ–å›ç­”
function formatAnswer(text) {
    // ç®€å•çš„ Markdown é£æ ¼æ ¼å¼åŒ–
    return text
        .replace(/\n\n/g, '</p><p>')
        .replace(/\n/g, '<br>')
        .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
        .replace(/`(.+?)`/g, '<code>$1</code>');
}

// ç¤ºä¾‹é—®é¢˜
document.querySelectorAll('.example-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        const question = btn.dataset.question;
        document.getElementById('question-input').value = question;
    });
});
</script>
{% endblock %}
