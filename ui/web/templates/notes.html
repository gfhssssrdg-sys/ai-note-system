{% extends "base.html" %}

{% block title %}ç¬”è®°åˆ—è¡¨ - AI Note System{% endblock %}

{% block content %}<div class="page-header">
    <h1>ğŸ“ ç¬”è®°åˆ—è¡¨</h1>
    <div class="search-box">
        <input type="text" id="search-input" placeholder="æœç´¢ç¬”è®°..." autocomplete="off">
        <button id="search-btn">ğŸ”</button>
    </div>
</div>

<div id="notes-container" class="notes-grid">
    <div class="loading">æ­£åœ¨åŠ è½½ç¬”è®°...</div>
</div>

<div id="search-results" class="search-results" style="display: none;"></div>

<div class="empty-state" id="empty-state" style="display: none;">
    <p>æš‚æ— ç¬”è®°</p>
    <a href="/upload" class="btn btn-primary">ä¸Šä¼ ç¬¬ä¸€ç¯‡ç¬”è®°</a>
</div>
{% endblock %}

{% block scripts %}<script>
let allNotes = [];

// åŠ è½½ç¬”è®°åˆ—è¡¨
async function loadNotes() {
    const container = document.getElementById('notes-container');
    const emptyState = document.getElementById('empty-state');
    
    try {
        const res = await fetch('/api/notes');
        const data = await res.json();
        allNotes = data.notes;
        
        if (allNotes.length === 0) {
            container.style.display = 'none';
            emptyState.style.display = 'block';
            return;
        }
        
        renderNotes(allNotes);
    } catch (err) {
        container.innerHTML = `<div class="error-box">åŠ è½½å¤±è´¥: ${err.message}</div>`;
    }
}

// æ¸²æŸ“ç¬”è®°åˆ—è¡¨
function renderNotes(notes) {
    const container = document.getElementById('notes-container');
    
    if (notes.length === 0) {
        container.innerHTML = '<div class="no-results">æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„ç¬”è®°</div>';
        return;
    }
    
    container.innerHTML = notes.map(note => {
        const typeIcons = {
            'url': 'ğŸŒ',
            'pdf': 'ğŸ“„',
            'markdown': 'ğŸ“',
            'image': 'ğŸ–¼ï¸'
        };
        const icon = typeIcons[note.type] || 'ğŸ“„';
        
        return `
            <a href="/note/${note.id}" class="note-card">
                <div class="note-header">
                    <span class="note-type">${icon} ${note.type}</span>
                    <span class="note-date">${note.created_at ? new Date(note.created_at).toLocaleDateString() : ''}</span>
                </div>
                <h3 class="note-title">${note.title}</h3>
            </a>
        `;
    }).join('');
}

// æœç´¢åŠŸèƒ½
async function searchNotes(query) {
    if (!query.trim()) {
        renderNotes(allNotes);
        return;
    }
    
    try {
        const res = await fetch(`/api/search?q=${encodeURIComponent(query)}`);
        const data = await res.json();
        renderNotes(data.results.map(r => ({
            id: r.id,
            title: r.title,
            type: r.type,
            created_at: null,
            preview: r.preview
        })));
    } catch (err) {
        console.error('æœç´¢å¤±è´¥:', err);
    }
}

// äº‹ä»¶ç›‘å¬
document.getElementById('search-input').addEventListener('input', (e) => {
    searchNotes(e.target.value);
});

document.getElementById('search-btn').addEventListener('click', () => {
    searchNotes(document.getElementById('search-input').value);
});

// åˆå§‹åŒ–
loadNotes();
</script>
{% endblock %}
